<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="preconnect" href="https://i.imgur.com">
    <link rel="preconnect" href="https://i.ibb.co">
    <link rel="preconnect" href="https://acdn-us.mitiendanube.com">
    <link rel="preconnect" href="https://http2.mlstatic.com">
    
    <meta name="referrer" content="no-referrer">
    <title>Catálogo Mejorado - CACAHUATE NATURAL MARKET</title>
    
    <meta name="description" content="Tu tienda de confianza en Lanús. Encuentra suplementos, alimentos naturales, productos Sin TACC, cosmética y más. ¡Haz tu pedido online fácilmente!">
    <meta name="keywords" content="dietética, lanús, productos naturales, sin tacc, suplementos, mercado natural, cacahuate">
    <meta name="author" content="CACAHUATE NATURAL MARKET">
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://marketcacahuate.com.ar/">
    <meta property="og:title" content="CACAHUATE NATURAL MARKET | Catálogo Online">
    <meta property="og:description" content="Explora nuestro catálogo completo de productos naturales y saludables. Pide por WhatsApp y retira en Lanús o recibe en tu domicilio.">
    <meta property="og:image" content="https://i.imgur.com/BCGbBgz.jpeg">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="http://marketcacahuate.com.ar/">
    <meta name="twitter:title" content="CACAHUATE NATURAL MARKET">
    <meta name="twitter:description" content="Tu tienda natural en Lanús. Suplementos, alimentos orgánicos y más.">
    <meta name="twitter:image" content="https://i.imgur.com/BCGbBgz.jpeg">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700&family=Merriweather:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="shortcut icon" href="favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
    <link rel="manifest" href="site.webmanifest" />
</head>

<body>

<header>
    <div class="header-background" id="heroCarousel">
        <img src="https://i.imgur.com/BCGbBgz.jpeg" 
             class="active"
             fetchpriority="high"
             data-link="#main-nav-anchor" 
             data-text="Bienvenido a Cacahuate"
             alt="Especias y Frutos Secos">

        <img src="https://i.ibb.co/d4pz33VT/fondo-carrusel-2.jpg" 
             loading="lazy"
             data-link="#infusiones-section" 
             data-text="Ver Yerba Mate y Hierbas"
             alt="Yerba Mate Campo">
        
        <img src="https://i.ibb.co/GfxhJ1GT/live-kombu.jpg" 
             loading="lazy"
             data-link="#bebidas-section" 
             data-text="Ver Kombuchas"
             alt="Kombucha Live">
        
        <img src="https://i.ibb.co/fVTyYtYm/crema-de-mani.webp" 
             loading="lazy"
             data-link="#despensa-section" 
             data-text="Ver Cremas de Maní"
             alt="Crema de Maní">
        
        <img src="https://i.ibb.co/kCbQVZh/barras.webp" 
             loading="lazy"
             data-link="#snacks-section" 
             data-text="Ver Barras Proteicas"
             alt="Barras">
    </div>

    <div class="header-content">
        <div class="logo-container">
            <img src="https://i.imgur.com/QPR06jn.png" alt="Logo de CACAHUATE NATURAL MARKET">
        </div>
        
        <div class="address-container">
            <a href="https://www.google.com/maps/search/?api=1&query=CACAHUATE+NATURAL+MARKET+Coronel+D%27+Elia+2039%2C+Lan%C3%BAs" target="_blank" style="text-decoration: none; color: inherit;">
                <p class="address-header"><i class="fas fa-map-marker-alt"></i> Coronel D' Elia 2039, Lanús</p>
            </a>
        </div>
    </div>
</header>

    <nav class="main-nav">
      <a href="#" class="nav-logo" style="font-weight: bold; font-family: 'Merriweather', serif; font-size: 1.2em;">CACAHUATE</a>
        <div class="nav-links" id="navLinks"></div>
        <button class="hamburger-menu" id="hamburgerMenu" aria-label="Abrir menú de navegación">
            <i class="fas fa-bars"></i>
        </button>
    </nav>

    <div id="mobile-menu-container"></div>
    
    <div class="search-bar-container">
        <i class="fas fa-search"></i>
        <input type="text" id="globalSearchInput" placeholder="Buscar en todo el catálogo..." autocomplete="off">
        <button id="clearSearchBtn" class="search-clear-btn" aria-label="Borrar búsqueda" style="display: none;">
            <i class="fas fa-times"></i>
        </button>
        <div id="suggestionsBox" class="suggestions-box"></div>
    </div>

    <p id="globalNoResultsMessage" class="no-results-message" style="text-align: center;">No se encontraron productos que coincidan con tu búsqueda.</p>

    <main id="main-content" style="display: none;">
        <div id="product-sections-container"></div>
    </main>

    <div id="loading-indicator">
        <p>Cargando catálogo de productos...</p>
    </div>

    <footer>
        <p>© 2025 CACAHUATE NATURAL MARKET. Todos los derechos reservados.</p>
    </footer>

    <a href="https://wa.me/5491133974550" target="_blank" class="whatsapp-direct-btn" title="Consulta Directa" aria-label="Contactar por WhatsApp">
        <i class="fab fa-whatsapp"></i>
    </a>
    <button id="cartBtn" class="cart-btn" title="Ver Pedido" aria-label="Ver carrito de pedidos">
        <i class="fas fa-shopping-cart"></i>
        <span id="cartCounter" class="cart-counter" style="display: none;">0</span>
    </button>

   <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span>
            <img id="modalImg" src="" alt="Imagen del producto">
            <h3 id="modalTitle"></h3>
            <p id="modalDescriptionText" class="modal-description"></p>
            <p id="modalPriceText" class="modal-price"></p>
            <a id="modalWhatsappBtn" href="#" target="_blank" class="modal-whatsapp-btn"><i class="fab fa-whatsapp"></i> Consultar</a>
        </div>
    </div>

    <div id="imageZoomModal" class="modal">
        <span class="close-button">×</span>
        <img id="zoomImg" class="modal-content" alt="Imagen ampliada">
    </div>
    
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span>
            <h3>Mi Pedido</h3>
            <div id="cartItemsContainer">
                <p id="emptyCartMessage">Tu carrito está vacío.</p>
            </div>
            <div class="cart-summary">
                <h4 id="cartTotal">Total: $0</h4>
            </div>
            <a id="checkoutBtn" href="#" target="_blank" class="modal-whatsapp-btn"><i class="fab fa-whatsapp"></i> Realizar Pedido</a>
        </div>
    </div>

    <div id="toast" class="toast-notification"></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        const API = {
            data: null,
            async fetchData() {
                try {
                    const response = await fetch('./productos.json?v=' + new Date().getTime());
                    if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                    this.data = await response.json();
                    return true;
                } catch (error) {
                    console.error("Error:", error);
                    document.getElementById('loading-indicator').innerHTML = '<p style="color:var(--rojo-error);">Error al cargar el catálogo.</p>';
                    return false;
                }
            },
            getPhoneNumber() {
                return this.data ? this.data.phoneNumber : '5491133974550';
            }
        };

        const Store = {
            state: { cart: [] },
            productMap: new Map(),
            productList: [],
            loadCart() {
                const savedCart = localStorage.getItem('cacahuateCart');
                if (savedCart) this.state.cart = JSON.parse(savedCart);
            },
            saveCart() {
                localStorage.setItem('cacahuateCart', JSON.stringify(this.state.cart));
            },
            addProduct(product, quantity) {
                const cartItem = this.getProductInCart(product.name);
                if (cartItem) {
                    cartItem.quantity += quantity;
                } else {
                    this.state.cart.push({ product: product, quantity: quantity });
                }
                this.saveCart();
            },
            updateQuantity(productName, newQuantity) {
                const cartItem = this.getProductInCart(productName);
                if (cartItem) {
                    if (newQuantity > 0) {
                        cartItem.quantity = newQuantity;
                    } else {
                        this.removeFromCart(productName);
                    }
                }
                this.saveCart();
            },
            removeFromCart(productName) {
                this.state.cart = this.state.cart.filter(item => item.product.name !== productName);
                this.saveCart();
            },
            getProductInCart(productName) {
                return this.state.cart.find(item => item.product.name === productName);
            },
            getCartTotal() {
                return this.state.cart.reduce((total, item) => {
                    const price = item.product.price || 0;
                    return total + (price * item.quantity);
                }, 0);
            }
        };

        const UI = {
            elements: {
                navLinks: document.getElementById('navLinks'),
                productSectionsContainer: document.getElementById('product-sections-container'),
                mainContent: document.getElementById('main-content'),
                loadingIndicator: document.getElementById('loading-indicator'),
                hamburgerMenu: document.getElementById('hamburgerMenu'),
                cartCounter: document.getElementById('cartCounter'),
                cartModal: document.getElementById('cartModal'),
                productModal: document.getElementById('productModal'),
                imageZoomModal: document.getElementById('imageZoomModal'),
                cartItemsContainer: document.getElementById('cartItemsContainer'),
                emptyCartMessage: document.getElementById('emptyCartMessage'),
                checkoutBtn: document.getElementById('checkoutBtn'),
                globalSearchInput: document.getElementById('globalSearchInput'),
                clearSearchBtn: document.getElementById('clearSearchBtn'),
                suggestionsBox: document.getElementById('suggestionsBox'),
                globalNoResultsMessage: document.getElementById('globalNoResultsMessage'),
                cartTotal: document.getElementById('cartTotal'),
            },
            formatCurrency(value) {
                return new Intl.NumberFormat('es-AR', {
                    style: 'currency',
                    currency: 'ARS'
                }).format(value);
            },

            escapeHtmlAttr(str) {
                if (!str) return '';
                return str.replace(/"/g, '&quot;').replace(/'/g, '&apos;');
            },

            normalizeText(str) {
                if (!str) return '';
                return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            },

            debounce(func, wait) {
                let timeout;
                return function(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            },

            showToast(message) {
                const toast = document.getElementById("toast");
                if (!toast) return;
                
                toast.innerHTML = message;
                toast.className = "toast-notification show";
                setTimeout(function(){ 
                    toast.className = toast.className.replace("show", ""); 
                }, 3000);
            },

            createCardHTML(item) {
                const priceText = item.price ? this.formatCurrency(item.price) : 'Consultar precio';
                let images = Array.isArray(item.img) ? item.img : (item.img ? [item.img] : []);
                const mainImage = images.length > 0 ? images[0] : '';
                const safeName = this.escapeHtmlAttr(item.name);
                const safeImages = this.escapeHtmlAttr(JSON.stringify(images));

                let imageGalleryHtml = '';
                if (images.length > 1) {
                    let thumbs = '<div class="thumbnail-container">';
                    images.forEach((url, i) => {
                        const active = i === 0 ? 'active' : '';
                        thumbs += '<img src="' + url + '" class="thumbnail ' + active + '" data-img-src="' + url + '" alt="miniatura">';
                    });
                    thumbs += '</div>';
                    imageGalleryHtml = '<div class="image-gallery"><div class="main-image-container"><img src="' + mainImage + '" class="main-image" alt="' + safeName + '" loading="lazy"></div>' + thumbs + '</div>';
                } else {
                    imageGalleryHtml = '<div class="image-wrapper"><img src="' + mainImage + '" alt="' + safeName + '" loading="lazy" decoding="async"></div>';
                }

                return '<div class="card fade-in" data-name="' + safeName + '" data-price="' + (item.price || 0) + '" data-img=\'' + safeImages + '\'>' +
                       imageGalleryHtml +
                       '<div class="card-content">' +
                       '<h3>' + item.name + '</h3>' +
                       '<p class="description">' + (item.desc || '') + '</p>' +
                       '<div class="card-price" style="font-size: 1.4em; font-weight: bold; color: var(--azul-terroso-claro); margin-bottom: 15px;">' + priceText + '</div>' +
                       '<div class="card-actions">' +
                       '<div class="quantity-selector"><button class="quantity-btn decrease-qty">-</button><input type="number" class="quantity-input" value="0" min="0"><button class="quantity-btn increase-qty">+</button></div>' +
                       '<button class="add-to-cart-btn"><i class="fas fa-cart-plus"></i></button>' +
                       '<button class="details-btn"><i class="fas fa-eye"></i></button>' +
                       '</div></div></div>';
            },

            renderCartItems() {
                if (Store.state.cart.length === 0) {
                    this.elements.cartItemsContainer.innerHTML = '';
                    this.elements.cartItemsContainer.appendChild(this.elements.emptyCartMessage);
                    this.elements.emptyCartMessage.style.display = 'block';
                    this.elements.checkoutBtn.style.display = 'none';
                    this.elements.cartTotal.style.display = 'none';
                } else {
                    this.elements.emptyCartMessage.style.display = 'none';
                    this.elements.checkoutBtn.style.display = 'inline-block';
                    this.elements.cartTotal.style.display = 'block';
                    this.elements.cartItemsContainer.innerHTML = Store.state.cart.map(item => {
                        const mainImage = Array.isArray(item.product.img) ? item.product.img[0] : item.product.img;
                        return `<div class="cart-item" data-name="${item.product.name}"><img src="${mainImage}" alt="${item.product.name}"><div class="cart-item-info"><h4>${item.product.name}</h4><span>${this.formatCurrency(item.product.price || 0)}</span></div><div class="quantity-selector"><button class="quantity-btn decrease-qty">-</button><input type="number" class="quantity-input" value="${item.quantity}" min="0" name="cart-quantity"><button class="quantity-btn increase-qty">+</button></div></div>`;
                    }).join('');
                    const total = Store.getCartTotal();
                    this.elements.cartTotal.textContent = `Total: ${this.formatCurrency(total)}`;
                    let productList = "Hola, quisiera realizar un pedido:\n\n";
                    Store.state.cart.forEach(item => {
                        productList += `- ${item.product.name} (x${item.quantity}) = ${this.formatCurrency(item.product.price * item.quantity)}\n`;
                    });
                    productList += `\n*Total estimado: ${this.formatCurrency(total)}*`;
                    this.elements.checkoutBtn.href = `https://wa.me/${API.getPhoneNumber()}?text=${encodeURIComponent(productList)}`;
                }
            },

            updateCartCounter() {
                const totalItems = Store.state.cart.reduce((sum, item) => sum + item.quantity, 0);
                this.elements.cartCounter.textContent = totalItems;
                this.elements.cartCounter.style.display = totalItems > 0 ? 'flex' : 'none';
            },

          // --- FUNCIÓN OPTIMIZADA: RENDER LAYOUT ---
            // Mejora de rendimiento: Acumula el HTML en variables y lo inyecta una sola vez.
            renderLayout() {
                API.data.categories.sort((a, b) => a.title.localeCompare(b.title));
                
                let navLinksHTML = '';
                let sectionsHTML = '';

                // Helper interno para crear el texto HTML de una sección
                const createSectionString = (id, title, desc) => {
                    return `<section id="${id}-section" class="content-section fade-in">
                                <h1>${title}</h1>
                                <p class="section-description">${desc || ''}</p>
                            </section>
                            <div id="${id}-grid" class="cards-grid"></div>`;
                };

                API.data.categories.forEach(category => {
                    if (category.subcategories) {
                        category.subcategories.sort((a, b) => a.title.localeCompare(b.title));
                        
                        // 1. Crear menú desplegable (Dropdown) para el navbar
                        const dropdownItems = category.subcategories
                            .map(sub => `<a href="#${sub.id}-section">${sub.title}</a>`)
                            .join('');
                            
                        navLinksHTML += `<div class="dropdown">
                                            <button class="dropbtn">${category.title} <i class="fas fa-caret-down"></i></button>
                                            <div class="dropdown-content">${dropdownItems}</div>
                                         </div>`;
                        
                        // 2. Crear las secciones en el cuerpo de la página
                        category.subcategories.forEach(sub => {
                            sectionsHTML += createSectionString(sub.id, sub.title, sub.desc);
                        });
                    } else {
                        // Caso sin subcategorías: Link simple y Sección simple
                        navLinksHTML += `<a href="#${category.id}-section">${category.title}</a>`;
                        sectionsHTML += createSectionString(category.id, category.title, category.desc);
                    }
                });

                // --- MOMENTO CLAVE DE LA OPTIMIZACIÓN ---
                // Inyectamos todo el HTML al DOM una única vez al final.
                this.elements.navLinks.innerHTML = navLinksHTML;
                this.elements.productSectionsContainer.innerHTML = sectionsHTML;
            },
            
            buildMobileMenu() {
                const container = document.getElementById('mobile-menu-container');
                if (!container) return;
                let mainPanelHTML = `<div class="mobile-panel main-panel active">`;
                let subPanelsHTML = '';
                API.data.categories.forEach(category => {
                    if (category.subcategories) {
                        mainPanelHTML += `<a href="#" class="mobile-nav-trigger" data-target-panel="panel-${category.id}">${category.title} <i class="fas fa-chevron-right"></i></a>`;
                        subPanelsHTML += `<div class="mobile-panel sub-panel" id="panel-${category.id}"><a href="#" class="mobile-nav-back"><i class="fas fa-chevron-left"></i> Volver a Categorías</a><h4 class="mobile-panel-title">${category.title}</h4>`;
                        category.subcategories.forEach(sub => {
                            subPanelsHTML += `<a href="#${sub.id}-section" class="mobile-nav-link">${sub.title}</a>`;
                        });
                        subPanelsHTML += `</div>`;
                    } else {
                        mainPanelHTML += `<a href="#${category.id}-section" class="mobile-nav-link">${category.title}</a>`;
                    }
                });
                mainPanelHTML += `</div>`;
                container.innerHTML = mainPanelHTML + subPanelsHTML;
            },

            renderAllProducts() {
                // Ya estaba optimizado usando .join(''), no requiere cambios mayores
                // al renderizar cuadrícula por cuadrícula.
                for (const categoryId in API.data.products) {
                    const grid = document.getElementById(`${categoryId}-grid`);
                    if (grid) {
                        grid.innerHTML = API.data.products[categoryId].map(item => this.createCardHTML(item)).join('');
                    }
                }
            },

            toggleModal(modal, show) {
                modal.style.display = show ? "flex" : "none";
            },

            openProductModal(card) {
                const name = card.dataset.name;
                const price = card.dataset.price;
                const images = JSON.parse(card.dataset.img || '[]');
                const product = Store.productMap.get(name);
                
                document.getElementById("modalTitle").textContent = name;
                document.getElementById("modalImg").src = images[0] || 'https://placehold.co/400x400/2F2F2F/FFFFFF?text=Imagen+no+disponible';
                document.getElementById("modalDescriptionText").textContent = product ? product.desc : 'Sin descripción';
                document.getElementById("modalPriceText").innerHTML = `<strong style='font-size:1.2em;'>Precio: ${this.formatCurrency(parseFloat(price || '0'))}</strong>`;
                document.getElementById("modalWhatsappBtn").href = `https://wa.me/${API.getPhoneNumber()}?text=${encodeURIComponent(`Hola, quisiera consultar sobre el producto: ${name}`)}`;
                this.toggleModal(this.elements.productModal, true);
            },
            
            openZoomModal(src) {
                const modal = this.elements.imageZoomModal;
                const img = document.getElementById('zoomImg');
                img.src = src;
                this.toggleModal(modal, true);
            },

            showMainContent() {
                this.elements.loadingIndicator.style.display = 'none';
                this.elements.mainContent.style.display = 'block';
            },

            initScrollAnimations() {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) entry.target.classList.add('is-visible');
                    });
                }, { threshold: 0.1 });
                document.querySelectorAll('.fade-in').forEach(el => observer.observe(el));
            },

            initHeroCarousel() {
                const slides = document.querySelectorAll('#heroCarousel img');
                if (slides.length === 0) return;
                let currentSlide = 0;
                setInterval(() => {
                    slides[currentSlide].classList.remove('active');
                    currentSlide = (currentSlide + 1) % slides.length;
                    slides[currentSlide].classList.add('active');
                }, 5000); 
            },

            renderSuggestions(matches) {
                const box = this.elements.suggestionsBox;
                box.innerHTML = '';
                
                if (matches.length === 0) {
                    box.style.display = 'none';
                    return;
                }

                matches.slice(0, 6).forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    const imgUrl = (Array.isArray(product.img) && product.img.length > 0) ? product.img[0] : 'https://placehold.co/50x50?text=IMG';
                    item.innerHTML = `<img src="${imgUrl}" alt="miniatura"><span>${product.name}</span>`;
                    item.addEventListener('click', () => {
                        this.elements.globalSearchInput.value = product.name;
                        box.style.display = 'none';
                        this.handleSearch(true);
                    });
                    box.appendChild(item);
                });
                box.style.display = 'block';
            },

            handleSearch(scrollToFirst = false) {
                const rawSearch = UI.elements.globalSearchInput.value || '';
                const searchTerm = this.normalizeText(rawSearch.trim());
                let totalVisibleCards = 0;
                let firstCardFound = null;

                if(this.elements.clearSearchBtn) {
                    this.elements.clearSearchBtn.style.display = rawSearch.length > 0 ? 'block' : 'none';
                }

                if (searchTerm === '') {
                    this.elements.suggestionsBox.style.display = 'none';
                    document.querySelectorAll('.cards-grid').forEach(grid => {
                        grid.style.display = 'grid';
                        grid.previousElementSibling.style.display = 'block';
                        grid.querySelectorAll('.card').forEach(c => c.style.display = 'flex');
                    });
                    this.elements.globalNoResultsMessage.style.display = 'none';
                    return;
                }

                document.querySelectorAll('.cards-grid').forEach(grid => {
                    let visibleCardsInGrid = 0;
                    let isCategoryMatch = false;

                    const section = grid.previousElementSibling;
                    if (section && section.classList.contains('content-section')) {
                        const titleElement = section.querySelector('h1');
                        if (titleElement) {
                            const categoryTitle = this.normalizeText(titleElement.innerText);
                            if (categoryTitle.includes(searchTerm)) isCategoryMatch = true;
                        }
                    }

                    grid.querySelectorAll('.card').forEach(card => {
                        const cardText = this.normalizeText(card.innerText);
                        const isProductMatch = cardText.includes(searchTerm);
                        const showCard = isProductMatch || isCategoryMatch;
                        
                        card.style.display = showCard ? 'flex' : 'none';
                        
                        if(showCard) {
                            visibleCardsInGrid++;
                            totalVisibleCards++;
                            if (!firstCardFound) firstCardFound = card;
                        }
                    });

                    if (section) section.style.display = visibleCardsInGrid > 0 ? 'block' : 'none';
                    grid.style.display = visibleCardsInGrid > 0 ? 'grid' : 'none';
                });

                if (!scrollToFirst) { 
                    const suggestions = Store.productList.filter(p => 
                        this.normalizeText(p.name).includes(searchTerm)
                    );
                    this.renderSuggestions(suggestions);
                }

                if (UI.elements.globalNoResultsMessage) {
                    UI.elements.globalNoResultsMessage.style.display = (totalVisibleCards === 0) ? 'block' : 'none';
                }

                if (scrollToFirst && firstCardFound) {
                    setTimeout(() => {
                        const yOffset = -120; 
                        const y = firstCardFound.getBoundingClientRect().top + window.pageYOffset + yOffset;
                        window.scrollTo({top: y, behavior: 'smooth'});
                    }, 100);
                }
            },
        };

        const App = {
            async init() {
                const dataLoaded = await API.fetchData();
                if (!dataLoaded) return;
                Store.loadCart();
                
                // Primero renderizamos la estructura (Optimizado)
                UI.renderLayout();
                // Luego el menú móvil
                UI.buildMobileMenu();
                // Finalmente llenamos las grillas con productos
                UI.renderAllProducts();
                
                for (const categoryId in API.data.products) {
                    API.data.products[categoryId].forEach(product => {
                        Store.productMap.set(product.name, product);
                        Store.productList.push(product);
                    });
                }
                
                UI.updateCartCounter();
                UI.showMainContent();
                UI.initScrollAnimations();
                UI.initHeroCarousel();
                this.setupEventListeners();
            },

            setupEventListeners() {
                document.body.addEventListener('click', (e) => {
                    const card = e.target.closest('.card');
                    if (card) {
                        if (e.target.matches('.thumbnail')) {
                            const mainImage = card.querySelector('.main-image');
                            const newSrc = e.target.dataset.imgSrc;
                            if (mainImage && newSrc) mainImage.src = newSrc;
                            card.querySelectorAll('.thumbnail').forEach(thumb => thumb.classList.remove('active'));
                            e.target.classList.add('active');
                        } else if (e.target.closest('.main-image-container, .image-wrapper')) {
                             const imageToZoom = card.querySelector('.main-image') || card.querySelector('.image-wrapper img');
                             if (imageToZoom) UI.openZoomModal(imageToZoom.src);
                        } else if (e.target.closest('.details-btn')) {
                            UI.openProductModal(card);
                        } else if (e.target.closest('.add-to-cart-btn')) {
                            const quantityInput = card.querySelector('.quantity-input');
                            const quantity = parseInt(quantityInput.value, 10);
                            
                            if (quantity > 0) {
                                const product = { name: card.dataset.name, img: JSON.parse(card.dataset.img || '[]'), price: parseFloat(card.dataset.price || '0') };
                                Store.addProduct(product, quantity);
                                UI.updateCartCounter();
                                UI.showToast(`<i class="fas fa-check-circle"></i> ¡Agregaste ${quantity} ${product.name}!`);
                                if(quantityInput) quantityInput.value = 0;
                            } else {
                                UI.showToast(`<i class="fas fa-exclamation-circle"></i> Elige una cantidad primero`);
                            }
                        } else if (e.target.matches('.quantity-btn')) {
                            const input = card.querySelector('.quantity-input');
                            if(input){
                                let currentValue = parseInt(input.value, 10);
                                if (e.target.matches('.increase-qty')) input.value = currentValue + 1;
                                else if (e.target.matches('.decrease-qty') && currentValue > 0) input.value = currentValue - 1;
                            }
                        }
                    }
                    
                    if (!e.target.closest('.search-bar-container')) {
                        UI.elements.suggestionsBox.style.display = 'none';
                    }
                });

                document.addEventListener('click', (e) => {
                     if (e.target.closest('.close-button') || e.target.classList.contains('modal')) {
                        UI.toggleModal(UI.elements.productModal, false);
                        UI.toggleModal(UI.elements.imageZoomModal, false);
                        UI.toggleModal(UI.elements.cartModal, false);
                    }
                });

                UI.elements.cartModal.addEventListener('click', (e) => {
                    const cartItem = e.target.closest('.cart-item');
                    if (!cartItem) return;
                    const productName = cartItem.dataset.name;
                    const input = cartItem.querySelector('.quantity-input');
                    if(!input) return;
                    let quantity = parseInt(input.value, 10);
                    if (e.target.matches('.increase-qty')) Store.updateQuantity(productName, quantity + 1);
                    else if (e.target.matches('.decrease-qty')) Store.updateQuantity(productName, quantity - 1);
                    UI.renderCartItems();
                    UI.updateCartCounter();
                });

                UI.elements.cartModal.addEventListener('change', (e) => {
                    if (e.target.matches('.quantity-input[name="cart-quantity"]')) {
                        const cartItem = e.target.closest('.cart-item');
                        if(!cartItem) return;
                        const newQuantity = parseInt(e.target.value, 10);
                        Store.updateQuantity(cartItem.dataset.name, newQuantity);
                        UI.renderCartItems();
                        UI.updateCartCounter();
                    }
                });

                document.getElementById('cartBtn').addEventListener('click', () => {
                    UI.renderCartItems();
                    UI.toggleModal(UI.elements.cartModal, true);
                });

                UI.elements.hamburgerMenu.addEventListener('click', () => {
                    const container = document.getElementById('mobile-menu-container');
                    if (!container) return;
                    const isOpen = container.classList.toggle('open');
                    document.body.classList.toggle('menu-open', isOpen);
                    document.documentElement.classList.toggle('menu-open', isOpen);
                    if (!isOpen) {
                        container.classList.remove('sub-panel-active');
                        const mainPanel = container.querySelector('.mobile-panel.main-panel');
                        if (mainPanel) mainPanel.classList.add('active');
                        container.querySelectorAll('.mobile-panel.sub-panel').forEach(p => p.classList.remove('active'));
                    }
                });

                document.getElementById('mobile-menu-container').addEventListener('click', (e) => {
                    const container = document.getElementById('mobile-menu-container');
                    const trigger = e.target.closest('.mobile-nav-trigger');
                    if (trigger) {
                        e.preventDefault();
                        const targetPanel = container.querySelector(`#${trigger.dataset.targetPanel}`);
                        if (targetPanel) {
                            container.classList.add('sub-panel-active');
                            targetPanel.classList.add('active');
                        }
                    }
                    const backButton = e.target.closest('.mobile-nav-back');
                    if (backButton) {
                        e.preventDefault();
                        container.classList.remove('sub-panel-active');
                        backButton.closest('.mobile-panel').classList.remove('active');
                    }
                    const finalLink = e.target.closest('.mobile-nav-link');
                    if (finalLink) {
                        container.classList.remove('open');
                        document.body.classList.remove('menu-open');
                        document.documentElement.classList.remove('menu-open');
                        container.classList.remove('sub-panel-active');
                        container.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
                    }
                });

                document.body.addEventListener('click', (e) => {
                    const container = document.getElementById('mobile-menu-container');
                    if (!container || !container.classList.contains('open')) return;
                    if (e.target.closest('#' + UI.elements.hamburgerMenu.id)) return;
                    if (e.target.closest('#' + container.id)) return;
                    container.classList.remove('open');
                    document.body.classList.remove('menu-open');
                    document.documentElement.classList.remove('menu-open');
                    container.classList.remove('sub-panel-active');
                    container.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
                });

                const debouncedSearch = UI.debounce(() => UI.handleSearch(false), 300);
                
                UI.elements.globalSearchInput.addEventListener('input', debouncedSearch);
                UI.elements.globalSearchInput.addEventListener('focus', () => {
                    if(UI.elements.globalSearchInput.value.trim() !== '') UI.handleSearch(false);
                });

                if (UI.elements.clearSearchBtn) {
                    UI.elements.clearSearchBtn.addEventListener('click', () => {
                        UI.elements.globalSearchInput.value = '';
                        UI.handleSearch(false);
                        UI.elements.globalSearchInput.focus();
                    });
                }
            },
        };

        App.init();
    });
</script>
</body>
</html>